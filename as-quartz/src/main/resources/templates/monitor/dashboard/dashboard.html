<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('仪表盘')"/>
</head>
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-title">
                    <div class="row">
                        <div class="col-sm-6">
                            <h1><i class="fa fa-desktop"></i> [[#{monitor.dashboard}]]</h1>
                        </div>
                        <div class="col-sm-6">
                            <button id="switchButton" class="btn btn-danger dim pull-right" type="button"><i class="fa fa-bell-o"></i></button>
                        </div>
                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <div class="col-sm-12 select-table table-bordered">
                                    <table id="bootstrap-table-sql" data-auto-refresh="true" data-auto-refresh-interval="15"></table>
                                    <div id="sql-update-time" class="badge badge-success pull-right" style="margin-top: 10px"><span class="title">[[#{common.last.update.time}]]：</span><span class="time"></span></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <div class="col-sm-12 select-table table-bordered">
                                    <table id="bootstrap-table-elastic" data-auto-refresh="true" data-auto-refresh-interval="15"></table>
                                    <div id="elastic-update-time" class="badge badge-success pull-right" style="margin-top: 10px"><span class="title">[[#{common.last.update.time}]]：</span><span class="time"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <div class="col-sm-12 select-table table-bordered">
                                    <table id="bootstrap-table-api" data-auto-refresh="true" data-auto-refresh-interval="15"></table>
                                    <div id="api-update-time" class="badge badge-success pull-right" style="margin-top: 10px"><span class="title">[[#{common.last.update.time}]]：</span><span class="time"></span></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <div class="col-sm-12 select-table table-bordered">
                                    <table id="bootstrap-table-export" data-auto-refresh="true" data-auto-refresh-interval="15"></table>
                                    <div id="export-update-time" class="badge badge-success pull-right" style="margin-top: 10px"><span class="title">[[#{common.last.update.time}]]：</span><span class="time"></span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="alarmSound" style="margin:0; display:none;" loop>
    <source th:src="'/music/Gold-PLease_' + #{locale} +'.mp3'" type="audio/mpeg"/>
</audio>

<th:block th:include="include :: footer"/>
<th:block th:include="include :: bootstrap-table-auto-refresh-js" />
<script th:inline="javascript">
    var statusDatas = [[${@dict.getType('sys_common_status')}]];
    var PLATFORMDatas = [[${@dict.getType('ub8_platform_type')}]];
    var prefix = ctx + "monitor/dashboard";

    function checkAlert(){
        if (isSwitchOn()){
            var sqlJobRow = $('#bootstrap-table-sql').bootstrapTable('getOptions').totalRows
            var apiJobRow = $('#bootstrap-table-api').bootstrapTable('getOptions').totalRows
            var elasticJobRow = $('#bootstrap-table-elastic').bootstrapTable('getOptions').totalRows
            var switchOnNum = $("table .fa-toggle-on").length
            var totalRow = sqlJobRow + apiJobRow + elasticJobRow
            if (totalRow && switchOnNum){
                if (isPaused()){
                    play()
                }
            } else if (!isPaused()){
                pause()
            }
        }
    }

    function play(){
        document.getElementById("alarmSound").play();
    }

    //      暫停播放音效
    function pause(){
        document.getElementById("alarmSound").pause();
    }

    //      是否播放音效中
    function isPaused(){
        return document.getElementById("alarmSound").paused;
    }

    //      打開開關
    function switchOn(){
        $("#switchButton").html('<i class="fa fa-bell-o"></i>');
        checkAlert()
    }

    //      關閉開關
    function switchOff(){
        $("#switchButton").html('<i class="fa fa-bell-slash-o"></i>');
        checkAlert()
    }

    function isSwitchOn(){
        return $("#switchButton").html() === '<i class="fa fa-bell-o"></i>';
    }

    function sqlLastUpdateTime(){
        checkAlert()
        $("#sql-update-time .time").text($.common.dateFormat(new Date(),'yyyy-MM-dd HH:mm:ss'));
    }
    function exportLastUpdateTime(){
        checkAlert()
        $("#export-update-time .time").text($.common.dateFormat(new Date(),'yyyy-MM-dd HH:mm:ss'));
    }
    function elasticLastUpdateTime(){
        checkAlert()
        $("#elastic-update-time .time").text($.common.dateFormat(new Date(),'yyyy-MM-dd HH:mm:ss'));
    }
    function apiLastUpdateTime(){
        checkAlert()
        $("#api-update-time .time").text($.common.dateFormat(new Date(),'yyyy-MM-dd HH:mm:ss'));
    }

    $(document).ready(function(){
        $("#switchButton").bind("click", function(){
            if(isSwitchOn()){
                switchOff();
            }else{
                switchOn();
            }
            if(isSwitchOn()){
                checkAlert();
            }else{
                if (!isPaused()){
                    pause()
                }
            }
        });
    });

    $(function(){
        var options = {
            url: prefix + "/updateSqlJob",
            detailUrl: ctx + 'monitor/sqlJobLog/detail/{id}"',
            id:'bootstrap-table-sql',
            pageSize: 100,
            pageNumber: 1,
            pageList: [100],
            striped: true,
            showSearch: false,
            showRefresh: false,
            showToggle: false,
            showColumns: false,
            onLoadSuccess: sqlLastUpdateTime,
            headerStyle: headerStyle,
            onClickCell: onClickSqlCell,
            sortName: "startTime",
            sortOrder: "desc",
            modalName: i18n('sql.job.sql.task'),
            columns: [
                [{
                    title : i18n('sql.job.sql.task'),
                    align : 'center',
                    field: '',
                    colspan : 7
                }
                ],
                [{
                    field: 'startTime',
                    title: i18n('common.start.time'),
                    align: 'center',
                    cellStyle: {
                        css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                    }
                },
                    {
                        field: 'moniJob.chName',
                        title: i18n('sql.job.name_zh'),
                        visible: i18n('locale') !== 'en-US',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniJob.enName',
                        title: i18n('sql.job.name_en'),
                        visible: i18n('locale') === 'en-US',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniJob.platform',
                        title: i18n('sql.job.platform'),
                        formatter: function (value, row, index) {
                            return $.table.selectDictLabel(PLATFORMDatas, value);
                        },
                        align: 'center',
                    },
                    {
                        field: 'status',
                        title: i18n('sql.job.execute.status'),
                        formatter: function(value, row, index) {
                            return $.table.selectDictLabel(statusDatas, value);
                        },
                        align: 'center',
                    },
                    {
                        field: 'alertStatus',
                        title: i18n('monitor.alert.switch'),
                        align: 'center',
                        formatter: function (value, row, index) {
                            return sqlJobAlertTools(row);
                        },
                    },
                    {
                        field: 'callback',
                        title: i18n('sql.job.log.callback'),
                        align: 'center',
                        formatter: function(value, row, index) {
                            var actions = [];
                            actions.push('<a class="btn btn-primary btn-xs" href="javascript:void(0)" onclick="callbackSql(\'' + row.id + '\')"><i class="fa fa-check"></i></a>');
                            return actions.join('');
                        }
                    }
                ]
            ]
        };
        $.table.init(options);
        switchOn()
    })

    $(function(){
        var options = {
            url: prefix + "/updateExportJob",
            id:'bootstrap-table-export',
            pageSize: 100,
            pageNumber: 1,
            pageList: [100],
            striped: true,
            showSearch: false,
            showRefresh: false,
            showToggle: false,
            showColumns: false,
            headerStyle: headerStyle,
            onLoadSuccess: exportLastUpdateTime,
            sortName: "startTime",
            sortOrder: "desc",
            modalName: i18n('export.job'),
            columns: [
                [{
                    title : i18n('export.job'),
                    align : 'center',
                    field: '',
                    colspan : 7
                }
                ],
                [{
                    field: 'startTime',
                    title: i18n('common.start.time'),
                    align: 'center',
                    cellStyle: {
                        css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                    }
                },
                    {
                        field: 'moniExport.ticketNumber',
                        title: 'Ticket Number',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniExport.chName',
                        title: i18n('sql.job.name_zh'),
                        visible: i18n('locale') !== 'en-US',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniExport.enName',
                        title: i18n('sql.job.name_en'),
                        visible: i18n('locale') === 'en-US',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniExport.platform',
                        title: i18n('sql.job.platform'),
                        formatter: function (value, row, index) {
                            return $.table.selectDictLabel(PLATFORMDatas, value);
                        },
                        align: 'center',
                    },
                    {
                        field: 'status',
                        title: i18n('sql.job.execute.status'),
                        formatter: function(value, row, index) {
                            return $.table.selectDictLabel(statusDatas, value);
                        },
                        align: 'center',
                    },
                    {
                        title: i18n('sql.job.log.callback'),
                        align: 'center',
                        formatter: function(value, row, index) {
                            var actions = [];
                            actions.push('<a class="btn btn-primary btn-xs" href="javascript:void(0)" onclick="callbackExport(\'' + row.id + '\')"><i class="fa fa-check"></i></a>');
                            return actions.join('');
                        }
                    }
                ]
            ]
        };
        $.table.init(options);
    })


    $(function(){
        var options = {
            url: prefix + "/updateApiJob",
            id:'bootstrap-table-api',
            pageSize: 100,
            pageNumber: 1,
            pageList: [100],
            striped: true,
            showSearch: false,
            showRefresh: false,
            showToggle: false,
            showColumns: false,
            headerStyle: headerStyle,
            onLoadSuccess: apiLastUpdateTime,
            sortName: "startTime",
            sortOrder: "desc",
            modalName: i18n('api.job'),
            columns: [
                [{
                    title : i18n('api.job'),
                    align : 'center',
                    field: '',
                    colspan : 7
                }
                ],
                [{
                    field: 'startTime',
                    title: i18n('common.start.time'),
                    align: 'center',
                    cellStyle: {
                        css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                    }
                },
                    {
                        field: 'moniApi.chName',
                        title: i18n('sql.job.name_zh'),
                        visible: i18n('locale') !== 'en-US',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniApi.enName',
                        title: i18n('sql.job.name_en'),
                        visible: i18n('locale') === 'en-US',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniApi.platform',
                        title: i18n('sql.job.platform'),
                        formatter: function (value, row, index) {
                            return $.table.selectDictLabel(PLATFORMDatas, value);
                        },
                        align: 'center',
                    },
                    {
                        field: 'status',
                        title: i18n('sql.job.execute.status'),
                        formatter: function(value, row, index) {
                            return $.table.selectDictLabel(statusDatas, value);
                        },
                        align: 'center',
                    },
                    {
                        field: 'alertStatus',
                        title: i18n('monitor.alert.switch'),
                        align: 'center',
                        formatter: function (value, row, index) {
                            return apiJobAlertTools(row);
                        },
                    },
                    {
                        title: i18n('sql.job.log.callback'),
                        align: 'center',
                        formatter: function(value, row, index) {
                            var actions = [];
                            actions.push('<a class="btn btn-primary btn-xs" href="javascript:void(0)" onclick="callbackApi(\'' + row.id + '\')"><i class="fa fa-check"></i></a>');
                            return actions.join('');
                        }
                    }
                ]
            ]
        };
        $.table.init(options);
    })

    $(function(){
        var options = {
            url: prefix + "/updateElasticJob",
            id:'bootstrap-table-elastic',
            pageSize: 100,
            pageNumber: 1,
            pageList: [100],
            striped: true,
            showSearch: false,
            showRefresh: false,
            showToggle: false,
            showColumns: false,
            headerStyle: headerStyle,
            onLoadSuccess: elasticLastUpdateTime,
            sortName: "startTime",
            sortOrder: "desc",
            modalName: i18n('elastic.job'),
            columns: [
                [{
                    title : i18n('elastic.job'),
                    align : 'center',
                    field: '',
                    colspan : 7
                }
                ],
                [{
                    field: 'startTime',
                    title: i18n('common.start.time'),
                    align: 'center',
                    cellStyle: {
                        css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                    }
                },
                    {
                        field: 'moniElastic.chName',
                        title: i18n('sql.job.name_zh'),
                        visible: i18n('locale') !== 'en-US',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniElastic.enName',
                        title: i18n('sql.job.name_en'),
                        visible: i18n('locale') === 'en-US',
                        align: 'center',
                        cellStyle: {
                            css:{"background-color":"rgba(220,38,38,0.2)","font-weight": 700,"color":"red"}
                        }
                    },
                    {
                        field: 'moniElastic.platform',
                        title: i18n('sql.job.platform'),
                        formatter: function (value, row, index) {
                            return $.table.selectDictLabel(PLATFORMDatas, value);
                        },
                        align: 'center',
                    },
                    {
                        field: 'status',
                        title: i18n('sql.job.execute.status'),
                        formatter: function(value, row, index) {
                            return $.table.selectDictLabel(statusDatas, value);
                        },
                        align: 'center',
                    },
                    {
                        field: 'alertStatus',
                        title: i18n('monitor.alert.switch'),
                        align: 'center',
                        formatter: function (value, row, index) {
                            return elasticJobAlertTools(row);
                        },
                    },
                    {
                        title: i18n('sql.job.log.callback'),
                        align: 'center',
                        formatter: function(value, row, index) {
                            var actions = [];
                            actions.push('<a class="btn btn-primary btn-xs" href="javascript:void(0)" onclick="callbackElastic(\'' + row.id + '\')"><i class="fa fa-check"></i></a>');
                            return actions.join('');
                        }
                    }
                ]
            ]
        };
        $.table.init(options);
    })


    /* sql检测调度任务告警显示 */
    function sqlJobAlertTools(row) {
        if (row.alertStatus === "1") {
            return '<i class=\"fa fa-toggle-off text-info fa-2x\" onclick="sqlJobAlertStart(\'' + row.id + '\')"></i> ';
        } else {
            return '<i class=\"fa fa-toggle-on text-info fa-2x\" onclick="sqlJobAlertStop(\'' + row.id + '\')"></i> ';
        }
    }

    /* sql检测告警-停用 */
    function sqlJobAlertStop(jobId) {
        $.operate.post(prefix + "/stopSqlJobAlert", {"id": jobId, "alertStatus": 1});
        checkAlert()
    }

    /* sql检测告警-启用 */
    function sqlJobAlertStart(jobId) {
        $.operate.post(prefix + "/startSqlJobAlert", {"id": jobId, "alertStatus": 0});
        checkAlert()
    }

    /* api检测调度任务告警显示 */
    function apiJobAlertTools(row) {
        if (row.alertStatus === "1") {
            return '<i class=\"fa fa-toggle-off text-info fa-2x\" onclick="apiJobAlertStart(\'' + row.id + '\')"></i> ';
        } else {
            return '<i class=\"fa fa-toggle-on text-info fa-2x\" onclick="apiJobAlertStop(\'' + row.id + '\')"></i> ';
        }
    }

    /* api检测告警-停用 */
    function apiJobAlertStop(jobId) {
        $.operate.post(prefix + "/stopApiJobAlert", {"id": jobId, "alertStatus": 1});
        checkAlert()
    }

    /* api检测告警-启用 */
    function apiJobAlertStart(jobId) {
        $.operate.post(prefix + "/startApiJobAlert", {"id": jobId, "alertStatus": 0});
        checkAlert()
    }

    /* elastic检测任务告警显示 */
    function elasticJobAlertTools(row) {
        if (row.alertStatus === "1") {
            return '<i class=\"fa fa-toggle-off text-info fa-2x\" onclick="elasticJobAlertStart(\'' + row.id + '\')"></i> ';
        } else {
            return '<i class=\"fa fa-toggle-on text-info fa-2x\" onclick="elasticJobAlertStop(\'' + row.id + '\')"></i> ';
        }
    }

    /*elastic检测任务告警-停用 */
    function elasticJobAlertStop(jobId) {
        $.operate.post(prefix + "/stopElasticJobAlert", {"id": jobId, "alertStatus": 1});
        checkAlert()
    }

    /* elastic检测任务告警-启用 */
    function elasticJobAlertStart(jobId) {
        $.operate.post(prefix + "/startElasticJobAlert", {"id": jobId, "alertStatus": 0});
        checkAlert()
    }

    function onClickSqlCell(field, value, row, $element){
        if (field !== 'callback' && field !== 'alertStatus'){
            $.operate.detail(row.id);
        }
    }

    function callbackSql(id){
        $.ajax({
            type:"GET",
            url:ctx + "monitor/sqlJobLog/callback/" + id,
            success : function(data) {
                if(data.code === 0){
                    $.modal.msgSuccess(i18n('sql.job.log.callback.success'));
                    $("#" + table.config['bootstrap-table-sql'].id).bootstrapTable('refreshOptions',table.config['bootstrap-table-sql']);
                } else {
                    $.modal.msgWarning(i18n('sql.job.log.callback.failure'));
                }
            },
            error : function (){
                $.modal.msgError(i18n('common.sys.error'));
            }
        });
    }

    function callbackExport(id){
        $.ajax({
            type:"GET",
            url:ctx + "monitor/exportJobLog/callback/" + id,
            success : function(data) {
                if(data.code === 0){
                    $.modal.msgSuccess(i18n('sql.job.log.callback.success'));
                    $("#" + table.config['bootstrap-table-export'].id).bootstrapTable('refreshOptions',table.config['bootstrap-table-export']);
                } else {
                    $.modal.msgWarning(i18n('sql.job.log.callback.failure'));
                }
            },
            error : function (){
                $.modal.msgError(i18n('common.sys.error'));
            }
        });
    }

    function callbackApi(id){
        $.ajax({
            type:"GET",
            url:ctx + "monitor/apiJobLog/callback/" + id,
            success : function(data) {
                if(data.code === 0){
                    $.modal.msgSuccess(i18n('sql.job.log.callback.success'));
                    $("#" + table.config['bootstrap-table-api'].id).bootstrapTable('refreshOptions',table.config['bootstrap-table-api']);
                } else {
                    $.modal.msgWarning(i18n('sql.job.log.callback.failure'));
                }
            },
            error : function (){
                $.modal.msgError(i18n('common.sys.error'));
            }
        });
    }

    function callbackElastic(id){
        $.ajax({
            type:"GET",
            url:ctx + "monitor/elasticJobLog/callback/" + id,
            success : function(data) {
                if(data.code === 0){
                    $.modal.msgSuccess(i18n('sql.job.log.callback.success'));
                    $("#" + table.config['bootstrap-table-elastic'].id).bootstrapTable('refreshOptions',table.config['bootstrap-table-elastic']);
                } else {
                    $.modal.msgWarning(i18n('sql.job.log.callback.failure'));
                }
            },
            error : function (){
                $.modal.msgError(i18n('common.sys.error'));
            }
        });
    }

    function headerStyle(column) {
        return {
            '': {
                css: { background: '#3c8dbc','font-size': '100%',color:'white','font-weight': 'bolder' }
            }
        }[column.field]
    }
</script>
</body>
</html>